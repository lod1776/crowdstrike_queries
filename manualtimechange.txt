// Time/Date Change Detection - Multi-Platform
// Detects manual time changes, NTP modifications, and timezone changes

// Windows: Time change events
in(#event_simpleName, values=["UserAccountLogon", "ProcessRollup2", "SyntheticProcessRollup2"])
| where event_platform="Win"
| where (
    // Time change via w32tm or timedate.cpl
    (in(FileName, values=["w32tm.exe", "timedate.cpl", "control.exe"]) AND 
     (CommandLine=/.*time.*/i OR CommandLine=/.*date.*/i OR CommandLine=/.*timezone.*/i))
    OR
    // PowerShell time change commands
    (FileName="powershell.exe" AND 
     (CommandLine=/.*Set-Date.*/i OR CommandLine=/.*Set-TimeZone.*/i OR 
      CommandLine=/.*\[System\.DateTime\].*/i OR CommandLine=/.*Win32_OperatingSystem.*LocalDateTime.*/i))
    OR
    // Registry modifications for timezone
    (FileName="reg.exe" AND CommandLine=/.*TimeZoneInformation.*/i)
    OR
    // Control panel time settings
    (FileName="control.exe" AND CommandLine=/.*timedate\.cpl.*/i)
)

UNION

// Windows: Event logs for time changes (if ingested)
#event_simpleName="EventLogEntry"
| where event_platform="Win"
| where (EventID=4616 OR EventID=1)
| eval ChangeType=case(
    EventID=4616, "System Time Changed",
    EventID=1, "Time Service Event"
)

UNION

// Linux: Time change commands
in(#event_simpleName, values=["ProcessRollup2", "SyntheticProcessRollup2"])
| where event_platform="Lin"
| where (
    // Direct time manipulation
    in(FileName, values=["date", "timedatectl", "hwclock", "ntpdate", "ntpd", "chronyd"])
    OR
    // NTP configuration changes
    (in(FileName, values=["vi", "vim", "nano", "sed", "echo"]) AND 
     (CommandLine=/.*\/etc\/ntp\.conf.*/i OR CommandLine=/.*\/etc\/chrony.*/i OR 
     CommandLine=/.*\/etc\/systemd\/timesyncd\.conf.*/i))
    OR
    // Timezone changes
    (CommandLine=/.*\/etc\/localtime.*/i OR CommandLine=/.*\/usr\/share\/zoneinfo.*/i)
    OR
    // Systemd timedate services
    (FileName="systemctl" AND CommandLine=/.*timesyncd.*/i)
)

UNION

// macOS: Time change commands
in(#event_simpleName, values=["ProcessRollup2", "SyntheticProcessRollup2"])
| where event_platform="Mac"
| where (
    // System date/time commands
    in(FileName, values=["date", "systemsetup", "ntpdate", "ntpd", "sntp"])
    OR
    // System Preferences modifications
    (FileName="systemsetup" AND 
     (CommandLine=/.*-setdate.*/i OR CommandLine=/.*-settime.*/i OR 
      CommandLine=/.*-settimezone.*/i OR CommandLine=/.*-setusingnetworktime.*/i))
    OR
    // NTP configuration
    (CommandLine=/.*\/etc\/ntp\.conf.*/i OR CommandLine=/.*ntpd.*/i)
    OR
    // Timezone changes
    (CommandLine=/.*\/etc\/localtime.*/i OR CommandLine=/.*\/usr\/share\/zoneinfo.*/i)
)

// Enrichment and filtering
| eval Platform=case(
    event_platform="Win", "Windows",
    event_platform="Lin", "Linux", 
    event_platform="Mac", "macOS"
)
| eval ChangeMethod=case(
    in(FileName, values=["w32tm.exe", "timedate.cpl", "date", "timedatectl", "systemsetup"]), "Direct Time Change",
    in(FileName, values=["ntpdate", "ntpd", "chronyd", "sntp"]), "NTP Service",
    in(FileName, values=["powershell.exe", "pwsh.exe"]), "PowerShell",
    in(FileName, values=["reg.exe", "regedit.exe"]), "Registry Modification",
    in(FileName, values=["vi", "vim", "nano", "sed", "echo"]), "Config File Edit",
    1=1, "Other"
)
| table _time, ComputerName, UserName, Platform, FileName, CommandLine, ChangeMethod, ParentProcessId, SHA256HashData
| sort -_time
