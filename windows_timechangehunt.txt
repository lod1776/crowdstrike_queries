(event_simpleName=ProcessRollup2 OR event_simpleName=AsepValueUpdate)
| search (
    (event_simpleName=ProcessRollup2 AND (
        FileName=w32tm.exe OR FileName=tzutil.exe OR FileName=timedate.cpl OR FileName=net.exe OR FileName=sc.exe OR
        CommandLine=*Set-Date* OR CommandLine=*Set-TimeZone* OR CommandLine=*w32tm* OR CommandLine=*tzutil* OR CommandLine=*net time* OR CommandLine=*sc config w32time*
    )) OR
    (event_simpleName=AsepValueUpdate AND 
        (RegistryPath=*\\TimeZoneInformation\\* OR RegistryPath=*\\W32Time\\*))
)
| eval DetectionMethod=case(
    event_simpleName="ProcessRollup2" AND match(CommandLine, "(?i)Set-Date"), "PowerShell Time Change",
    event_simpleName="ProcessRollup2" AND match(FileName, "(?i)w32tm"), "W32Time Command",
    event_simpleName="ProcessRollup2" AND match(FileName, "(?i)tzutil"), "Timezone Utility",
    event_simpleName="ProcessRollup2" AND match(CommandLine, "(?i)net time"), "Net Time Command",
    event_simpleName="AsepValueUpdate", "Registry Time Config Change",
    1=1, "Other Time Modification"
)
| eval Severity=case(
    match(ParentBaseFileName, "(?i)(cmd|powershell|wscript|cscript)"), "High",
    1=1, "Medium"
)
| table _time ComputerName UserName event_simpleName FileName CommandLine RegistryPath DetectionMethod Severity
| sort -_time
